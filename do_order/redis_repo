
from Auth.models import User, Driver
from counting import *
import redis
from config import settings
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).resolve().parent.parent))


class Redis_repository:
    def __init__(self):
        self.active_orders = redis.StrictRedis(
            host=settings.redis_info.host,
            port=settings.redis_info.port,
            password=settings.redis_info.password,
            charset="utf-8",
            decode_responses=True,
            db=1)

        self.active_drivers = redis.StrictRedis(
            host=settings.redis_info.host,
            port=settings.redis_info.port,
            password=settings.redis_info.password,
            charset="utf-8",
            decode_responses=True,
            db=2)

    def switch_driver_to_active(self, dr: Driver, latitude: str, longitude: str):
        self.active_drivers.setex(
            dr.id,
            settings.redis_info.ttl_length,
            latitude+":"+longitude)

    def switch_driver_to_inactive(self, dr: Driver):
        self.active_drivers.delete(dr.id)

    def create_active_order(self, user: User, latitude: str, longitude: str):
        self.active_orders.set(
            user.id,
            latitude+":"+longitude)


m = Redis_repository()

m.active_drivers.geoadd("friends", (-74.00020246342898,
                        40.717855101298305, "Mark B."))
